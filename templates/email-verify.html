{% extends '/base/style/base.html' %}

{% block content %}

<!-- ============================ User Dashboard ================================== -->
<section class="error-wrap bg-light">
    <div class="container">
        <div class="row justify-content-center align-content-center" style="height: 60vh;">
            <div class="col-lg-5 col-md-8 bg-white p-5 text-center rounded shadow">
                <div class="text-center">
                    <h2>Verifying your email...</h2>
                    <div class="spinner" id="spinner"></div>
                    <p id="message">Please wait...</p>
                    <a class="btn btn-primary mt-3 px-5" href="/">Back To Home</a>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- ============================ User Dashboard End ================================== -->

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
    apiKey: "{{ firebase_config.apiKey }}",
    authDomain: "{{ firebase_config.authDomain }}"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

const params = new URLSearchParams(window.location.search);
const mode = params.get('mode');
const actionCode = params.get('oobCode');

const spinner = document.getElementById('spinner');
const message = document.getElementById('message');

function handleVerifyEmail(actionCode) {
    auth.applyActionCode(actionCode)
        .then(async () => {
            await auth.currentUser?.reload();
            const user = auth.currentUser;

            if (user && user.emailVerified) {
                try {
                    const idToken = await user.getIdToken(true);
                    
                    const res = await fetch('/api/email-verified', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ idToken })
                    });

                    const result = await res.json();
                    console.log("Server response:", result);
                    
                } catch (err) {
                    console.error("Failed to update email verification in DB:", err);
                }
            }

            spinner.style.display = 'none';
            message.textContent = "Your email has been verified successfully! Redirecting to your account...";
            setTimeout(() => window.location.href = "/my-account", 3000);
        })
        .catch((error) => {
            console.error("Verification error:", error);
            spinner.style.display = 'none';
            message.textContent = "Verification failed: " + error.message;
        });
}

if (mode === 'verifyEmail' && actionCode) {
    handleVerifyEmail(actionCode);
} else {
    spinner.style.display = 'none';
    message.textContent = "Invalid or missing verification link.";
}
</script>

{% endblock %}
